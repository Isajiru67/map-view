<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>施設プロット（GeoJSON）</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    /* ちょいUI */
    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: rgba(255,255,255,.95);
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      max-width: 360px;
    }
    .panel h1 {
      font-size: 14px;
      margin: 0 0 8px 0;
    }
    .row { display: flex; gap: 8px; align-items: center; }
    .row input[type="text"]{
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
    }
    .row button{
      padding: 8px 10px;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .meta {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
      line-height: 1.35;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border: 1px solid #ddd;
      border-radius: 999px;
      font-size: 12px;
      background: #fafafa;
      margin-right: 6px;
    }
    .popup h2 {
      font-size: 14px;
      margin: 0 0 6px 0;
    }
    .popup table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .popup td {
      padding: 3px 0;
      vertical-align: top;
    }
    .popup td.key {
      color: #666;
      width: 88px;
      padding-right: 8px;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <h1>施設プロット（GeoJSON）</h1>
    <div class="row">
      <input id="q" type="text" placeholder="施設名/住所でフィルタ（例：幼稚園 / 福岡 / 宗像）" />
      <button id="reset">リセット</button>
    </div>
    <div class="meta">
      <span class="badge" id="count">読み込み中…</span>
      <span class="badge" id="visible">表示中…</span><br/>
      GeoJSON: <code>P29-23_40.geojson</code>（同階層）
    </div>
  </div>

  <script>
    // ===== 設定 =====
    const GEOJSON_FILE = "./P29-23_40.geojson";

    // GeoJSONはEPSG:6668 (JGD2011 / 緯度経度) で、Leaflet(WGS84)とほぼ同等の扱いでOK
    // 座標順は [lon, lat] → Leafletは [lat, lon] にする

    // ===== 地図初期化 =====
    const map = L.map("map", { preferCanvas: true });

    // OSMタイル
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // いったん日本あたり
    map.setView([35.681236, 139.767125], 5);

    // レイヤ管理
    const markersLayer = L.layerGroup().addTo(map);

    // データ保持
    let allFeatures = [];

    // ===== 表示用関数 =====
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function featureToPopupHTML(props, lat, lon) {
      // 主要項目（ファイルのプロパティ想定）
      const name = props?.P29_004 ?? "(名称なし)";
      const addr = props?.P29_005 ?? "";

      // それ以外も表に
      const rows = Object.entries(props || {}).map(([k, v]) => {
        return `<tr><td class="key">${escapeHtml(k)}</td><td>${escapeHtml(v)}</td></tr>`;
      }).join("");

      return `
        <div class="popup">
          <h2>${escapeHtml(name)}</h2>
          <div style="font-size:12px;color:#555;margin-bottom:6px;">
            ${addr ? escapeHtml(addr) : ""}
          </div>
          <table>
            ${rows}
            <tr><td class="key">lat/lon</td><td>${lat.toFixed(6)}, ${lon.toFixed(6)}</td></tr>
          </table>
        </div>
      `;
    }

    function renderFeatures(features) {
      markersLayer.clearLayers();

      const bounds = [];
      for (const f of features) {
        if (!f || f.type !== "Feature") continue;
        const g = f.geometry;
        if (!g || g.type !== "Point" || !Array.isArray(g.coordinates)) continue;

        const [lon, lat] = g.coordinates;
        if (typeof lat !== "number" || typeof lon !== "number") continue;

        const props = f.properties || {};
        const title = props.P29_004 || props.P29_005 || "施設";

        const marker = L.circleMarker([lat, lon], {
          radius: 5,
          weight: 1,
          fillOpacity: 0.7
        });

        marker.bindTooltip(escapeHtml(title), { direction: "top", sticky: true });
        marker.bindPopup(featureToPopupHTML(props, lat, lon), { maxWidth: 420 });

        marker.addTo(markersLayer);
        bounds.push([lat, lon]);
      }

      // 全体にフィット（点が少しでもある場合）
      if (bounds.length > 0) {
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.08));
      }

      document.getElementById("visible").textContent = `表示中: ${bounds.length}件`;
    }

    function applyFilter(query) {
      const q = (query || "").trim().toLowerCase();
      if (!q) return allFeatures;

      return allFeatures.filter(f => {
        const p = f?.properties || {};
        const hay = `${p.P29_004 ?? ""} ${p.P29_005 ?? ""} ${p.P29_001 ?? ""} ${p.P29_002 ?? ""}`.toLowerCase();
        return hay.includes(q);
      });
    }

    // ===== GeoJSON読み込み =====
    async function init() {
      try {
        const res = await fetch(GEOJSON_FILE, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch failed: ${res.status} ${res.statusText}`);

        const gj = await res.json();
        if (!gj || gj.type !== "FeatureCollection" || !Array.isArray(gj.features)) {
          throw new Error("GeoJSONがFeatureCollectionではありません");
        }

        allFeatures = gj.features;
        document.getElementById("count").textContent = `総件数: ${allFeatures.length}件`;

        renderFeatures(allFeatures);

        // 検索
        const qEl = document.getElementById("q");
        qEl.addEventListener("input", () => {
          const filtered = applyFilter(qEl.value);
          renderFeatures(filtered);
        });

        document.getElementById("reset").addEventListener("click", () => {
          qEl.value = "";
          renderFeatures(allFeatures);
        });

      } catch (e) {
        console.error(e);
        alert(
          "GeoJSONの読み込みに失敗しました。\n\n" +
          "・HTMLとGeoJSONが同じフォルダにあるか\n" +
          "・簡易サーバで開いているか（file://だと読めないことがあります）\n\n" +
          "詳細: " + e.message
        );
      }
    }

    init();
  </script>
</body>
</html>
